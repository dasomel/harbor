name: "Sync Upstream"

on:
  schedule:
    - cron: '0 0 * * *' # 매일 자정(UTC)에 실행
  workflow_dispatch:   # 수동 실행 버튼 추가

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync Upstream
        run: |
          # 원본 저장소 등록
          git remote add upstream https://github.com/goharbor/harbor.git
          git fetch upstream

          # 사용자 이름과 이메일 설정 (머지를 위해 필요)
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # 원본의 main 브랜치를 현재 저장소의 main으로 머지
          # --no-edit을 사용하여 자동 메시지 사용
          # 만약 충돌이 발생하면 이 단계에서 실패하며 알림이 감
          if git merge upstream/main --no-edit; then
            echo "Successfully merged upstream changes."
            git push origin main
          else
            echo "Conflict detected! Manual resolution required."
            exit 1
          fi
